# GitLab CI/CD 配置文件样例
image: registry.devops.rivtower.com/library/docker:stable
# 定义 stages（阶段），按顺序执行
stages:
  - build
  - code-quality-audit
  - image-build
  - k8s-deploy


# 全局变量设置
variables:
  MAVEM_IMAGE: registry.devops.rivtower.com/library/maven:3.9.11-eclipse-temurin-21-alpine
  IMAGE_NAME: ${RIVTOWER_REGISTRY_ADDRESS}/ckb-explorer/${CI_PROJECT_PATH}:${CI_COMMIT_REF_NAME}${CI_PIPELINE_ID}
  K8S_IMAGE: ${RIVTOWER_REGISTRY_ADDRESS}/library/kubectl:1.24.10 # k8s 部署使用的镜像
  NAME_SPACE: app-ckb-explorer

# 构建阶段
build-mvn-package:
  stage: build
  image: $MAVEM_IMAGE
  script:
    - echo "=============== mvn package  ==============="
    - mkdir -p .m2/repository
    - "rm -rf .m2/repository/com/ckb/explorer"
    - "mvn clean package -DskipTests -Dmaven.repo.local=.m2/repository"
    - echo "=============== 验证JAR文件生成 ==============="
    # 复制JAR文件到根目录，确保在image-build阶段能够可靠获取
    - "cp -f target/ckb-explorer-web.jar . || echo \"无法复制JAR文件到根目录\""
  cache:
    key: $CI_PROJECT_NAME-maven
    paths:
      - .m2/repository
    policy: pull-push
  artifacts:
    name: jar
    expire_in: 30 mins
    paths:
      - target/ckb-explorer-web.jar
      - ckb-explorer-web.jar
  tags:
    - docker_maven-3.6.2_k8s01

image-build:
  stage: image-build
  dependencies:
    - build-mvn-package
  script:
    - echo "=============== 验证文件是否存在 ==============="
    - "if [ -f target/ckb-explorer-web.jar ]; then echo \"JAR文件已找到\"; else echo \"错误: JAR文件不存在\" && exit 1; fi"
    - echo "=============== docker build image  ==============="
    - echo "${IMAGE_NAME}"
    - "docker login -u ${RIVTOWER_REGISTRY_USERNAME} -p ${RIVTOWER_REGISTRY_PASSWORD} ${RIVTOWER_REGISTRY_ADDRESS}"
    - "docker build -t ${IMAGE_NAME} ."
    - "docker push ${IMAGE_NAME}"
  only:
    - tags
    - develop
    - master
  tags:
    - docker_maven-3.6.2_k8s01

k8s-deploy-dev:
  stage: k8s-deploy
  image: $K8S_IMAGE
  before_script:
    - echo "imageName:"${IMAGE_NAME}
    - sed -i "s#IMAGE_NAME#${IMAGE_NAME}#g" deployment.yml
    - sed -i "s/NAME_SPACE/$NAME_SPACE/g" deployment.yml
  script:
    - "cat deployment.yml|sed 's/ENV/dev/g' > tmp.yml"
    # 添加错误处理，即使删除命令失败也继续执行
    - "kubectl --kubeconfig ${KUBERNETES_RIVTOWER_DEVELOPING_120} delete -n $NAME_SPACE pod -l app=ckb-explorer-web || echo '没有找到匹配的pod，继续部署'"
    - "kubectl --kubeconfig ${KUBERNETES_RIVTOWER_DEVELOPING_120} delete -n $NAME_SPACE ingress -l app=ckb-explorer-web || echo '没有找到匹配的ingress，继续部署'"
    - "kubectl --kubeconfig ${KUBERNETES_RIVTOWER_DEVELOPING_120} apply -f tmp.yml"
  only:
    - develop
  tags:
    - docker_maven-3.6.2_k8s01

# 代码质量检查
code-quality-audit:
  stage: code-quality-audit
  image: $MAVEM_IMAGE
  script:
    - mkdir -p .m2/repository
    - "mvn verify sonar:sonar -Dsonar.qualitygate.wait=true -Dmaven.test.skip=true --no-transfer-progress -Dmaven.repo.local=.m2/repository"
  cache:
    key: $CI_PROJECT_NAME-maven
    paths:
      - .m2/repository
    policy: pull
  only:
    - /^sonar.*$/
    - master
  tags:
    - docker_maven-3.6.2_k8s01