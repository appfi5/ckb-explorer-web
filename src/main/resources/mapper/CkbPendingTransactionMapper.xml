<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ckb.explorer.mapper.CkbPendingTransactionMapper">

  <resultMap id="BaseResultMap" type="com.ckb.explorer.entity.CkbPendingTransaction">
    <result property="txHash" column="tx_hash" jdbcType="OTHER"/>
    <result property="version" column="version" jdbcType="OTHER"/>
    <result property="inputCount" column="input_count" jdbcType="INTEGER"/>
    <result property="outputCount" column="output_count" jdbcType="INTEGER"/>
    <result property="witnesses" column="witnesses" jdbcType="OTHER"/>
    <result property="headerDeps" column="header_deps" jdbcType="OTHER"/>
    <result property="bytes" column="bytes" jdbcType="BIGINT"/>
    <result property="status" column="status" jdbcType="SMALLINT"/>
    <result property="createdAt" column="created_at" jdbcType="BIGINT"/>
    <result property="updatedAt" column="updated_at" jdbcType="BIGINT"/>
  </resultMap>

  <!-- 定义 resultMap 支持一对多映射 -->
  <resultMap id="transactionDtoResultMap" type="com.ckb.explorer.domain.dto.PendingTransactionDto">
    <result property="txHash" column="tx_hash"/>
    <result property="version" column="version"/>
    <result property="inputCount" column="input_count"/>
    <result property="outputCount" column="output_count"/>
    <result property="witnesses" column="witnesses"/>
    <result property="headerDeps" column="header_deps"/>
    <result property="bytes" column="bytes"/>
    <result property="status" column="status"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>

    <!-- 一对多映射：cellDeps -->
    <collection property="cellDeps" ofType="com.ckb.explorer.domain.resp.CellDependencyResponse" resultMap="CellDependencyResponseResultMap"/>
  </resultMap>

  <resultMap id="CellDependencyResponseResultMap" type="com.ckb.explorer.domain.resp.CellDependencyResponse">
    <!-- 配置2个<id>标签，标识CellDependencyResponse的唯一联合标识（替代id字段） -->
    <id column="tx_hash" property="txHash"/>
    <id column="index" property="index"/>
    <!-- 映射depType字段（注意：表中dep_type是SMALLINT，需转为字符串，可直接映射） -->
    <result column="dep_type" property="depType"/>
    <!-- 使用 association 映射嵌套对象 outPoint -->
    <association property="outPoint" javaType="com.ckb.explorer.domain.resp.OutPoint">
      <result property="txHash" column="outpoint_tx_hash"/>
      <result property="index" column="outpoint_index"/>
    </association>
  </resultMap>

  <select id="selectPendingTransactionWithCellDeps"
    resultMap="transactionDtoResultMap">
    SELECT
      '0x' || encode(ct.tx_hash, 'hex') as tx_hash,
      COALESCE(NULLIF(ltrim(encode(ct.version, 'hex'), '0'), ''), '0') AS version,
      ct.witnesses,
      ct.header_deps,
      ct.bytes + 4 as bytes,
      ct.status,
      acd.index as index,
      '0x' || encode(acd.outpoint_tx_hash, 'hex') as outpoint_tx_hash,
      acd.outpoint_index,
      CASE
        WHEN acd.dep_type = 0 THEN 'code'
        WHEN acd.dep_type = 1 THEN 'dep_group'
        END           AS dep_type
    FROM ckb_transaction ct
           LEFT JOIN tx_association_cell_dep acd on ct.tx_hash = acd.tx_hash
    WHERE ct.tx_hash = #{txHash}
    AND ct.status = 0
    order by acd.index

  </select>

</mapper>