<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ckb.explorer.mapper.LiveCellsMapper">

    <resultMap id="BaseResultMap" type="com.ckb.explorer.entity.LiveCells">
            <result property="id" column="id" jdbcType="BIGINT"/>
            <result property="capacity" column="capacity" jdbcType="BIGINT"/>
            <result property="lockScriptId" column="lock_script_id" jdbcType="BIGINT"/>
            <result property="typeScriptId" column="type_script_id" jdbcType="BIGINT"/>
            <result property="occupiedCapacity" column="occupied_capacity" jdbcType="BIGINT"/>
            <result property="blockNumber" column="block_number" jdbcType="BIGINT"/>
            <result property="blockTimestamp" column="block_timestamp" jdbcType="BIGINT"/>
            <result property="txId" column="tx_id" jdbcType="BIGINT"/>
            <result property="txHash" column="tx_hash" jdbcType="OTHER"/>
            <result property="data" column="data" jdbcType="OTHER"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,capacity,
        lock_script_id,type_script_id,
        occupied_capacity,block_number,
        block_timestamp,tx_id,tx_hash,data
    </sql>

  <resultMap id="liveCellsMap" type="com.ckb.explorer.domain.resp.LiveCellsResponse">
    <result property="id" column="id"/>
    <result property="typeScriptId" column="type_script_id"/>
    <result property="cellType" column="cell_type"/>
    <result property="txHash" column="tx_hash"/>
    <result property="cellIndex" column="cell_index"/>
    <result property="data" column="data"/>
    <result property="blockNumber" column="block_number"/>
    <result property="capacity" column="capacity"/>
    <result property="occupiedCapacity" column="occupied_capacity"/>
    <result property="blockTimestamp" column="block_timestamp"/>
    <result property="codeHash" column="code_hash"/>
    <result property="args" column="args"/>
  </resultMap>

  <select id="getLiveCellsByLockScriptIdWithTypeScriptId" resultMap="liveCellsMap">
    select
        lc.id                                     as id,
        lc.type_script_id                         as type_script_id,
        tse.cell_type                             as cell_type,
        '0x' || encode(lc.tx_hash, 'hex')         as tx_hash,
        lc.output_index                           as cell_index,
        '0x' || encode(lc.data, 'hex')            as data,
        lc.block_number                           as block_number,
        lc.capacity                               as capacity,
        lc.occupied_capacity                      as occupied_capacity,
        lc.block_timestamp                        as block_timestamp
    from live_cells lc
        left join type_script_extend tse on lc.type_script_id = tse.script_id
    where lc.lock_script_id = #{lockScriptId}
    <if test="typeScriptId != null">
      and lc.type_script_id = #{typeScriptId}
    </if>
      -- 筛选出ckb的live_cells
    <if test="typeScriptId == null">
      and lc.type_script_id is null
    </if>
    order by lc.block_number desc, lc.output_index asc
  </select>

  <select id="getOthersLiveCellsByLockScriptId" resultMap="liveCellsMap">
    select
        lc.id                                     as id,
        lc.type_script_id                         as type_script_id,
        null                                      as cell_type,
        '0x' || encode(lc.tx_hash, 'hex')         as tx_hash,
        lc.output_index                           as cell_index,
        '0x' || encode(lc.data, 'hex')            as data,
        lc.block_number                           as block_number,
        lc.capacity                               as capacity,
        lc.occupied_capacity                      as occupied_capacity,
        lc.block_timestamp                        as block_timestamp
    from live_cells lc
    where lc.lock_script_id = #{lockScriptId}
      and lc.type_script_id is not null
      and NOT EXISTS (
      SELECT 1
      FROM type_script_extend tse
      WHERE tse.script_id = lc.type_script_id -- 仅需判断是否存在匹配，无需返回数据
    )
      order by lc.block_number desc, lc.output_index asc
  </select>
</mapper>
